// File: SmartIrrigation.ino
#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <ArduinoJson.h>

#define WIFI_SSID "YOUR_WIFI"
#define WIFI_PASS "YOUR_PASS"
#define SOIL_PIN A0
#define PUMP_PIN D1
#define MOISTURE_THRESHOLD 400 // calibrate: lower = wetter

#define OWM_API_KEY "YOUR_OWM_KEY"
#define LAT "28.6139"  // example
#define LON "77.2090"

void setup() {
  Serial.begin(115200);
  pinMode(PUMP_PIN, OUTPUT);
  digitalWrite(PUMP_PIN, LOW);
  WiFi.begin(WIFI_SSID, WIFI_PASS);
  while (WiFi.status() != WL_CONNECTED) delay(500);
}

bool willRainSoon() {
  if (WiFi.status() != WL_CONNECTED) return false;
  HTTPClient http;
  String url = String("http://api.openweathermap.org/data/2.5/onecall?lat=") + LAT + "&lon=" + LON + "&exclude=minutely,daily&appid=" + OWM_API_KEY;
  http.begin(url);
  int code = http.GET();
  if (code != 200) { http.end(); return false; }
  String payload = http.getString();
  http.end();

  StaticJsonDocument<8192> doc;
  deserializeJson(doc, payload);
  // check next 3 hours for rain
  for (int i = 0; i < 3; ++i) {
    if (doc["hourly"][i]["rain"]) return true;
    if (doc["hourly"][i]["pop"] && doc["hourly"][i]["pop"].as<float>() > 0.5) return true;
  }
  return false;
}

void loop() {
  int soil = analogRead(SOIL_PIN);
  Serial.printf("Soil value: %d\n", soil);

  bool rain = willRainSoon();
  if (!rain && soil > MOISTURE_THRESHOLD) {
    // dry soil -> water
    digitalWrite(PUMP_PIN, HIGH);
    Serial.println("Pump ON");
  } else {
    digitalWrite(PUMP_PIN, LOW);
    Serial.println("Pump OFF");
  }
  delay(10*60*1000); // check every 10 minutes
}
